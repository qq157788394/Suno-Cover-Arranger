{"version":3,"sources":["node_modules/.pnpm/dexie@4.2.1/node_modules/dexie/import-wrapper.mjs","src/services/db.ts"],"sourcesContent":["// Making the module version consumable via require - to prohibit\n// multiple occurrancies of the same module in the same app\n// (dual package hazard, https://nodejs.org/api/packages.html#dual-package-hazard)\nimport _Dexie from \"./dist/dexie.js\";\nconst DexieSymbol = Symbol.for(\"Dexie\");\nconst Dexie = globalThis[DexieSymbol] || (globalThis[DexieSymbol] = _Dexie);\nif (_Dexie.semVer !== Dexie.semVer) {\n    throw new Error(`Two different versions of Dexie loaded in the same app: ${_Dexie.semVer} and ${Dexie.semVer}`);\n}\nconst { liveQuery, mergeRanges, rangesOverlap, RangeSet, cmp, Entity,\n    PropModification, replacePrefix, add, remove,\n    DexieYProvider } = Dexie;\nexport { liveQuery, mergeRanges, rangesOverlap, RangeSet, cmp, Dexie, Entity,\n    PropModification, replacePrefix, add, remove,\n    DexieYProvider};\n    \nexport default Dexie;\n","/**\n * 数据库服务模块\n * 负责处理应用程序的本地数据库操作，使用 Dexie.js 作为数据库管理工具\n * 主要功能：\n * 1. 用户数据的增删改查\n * 2. 项目数据的管理\n * 3. 风格配置的存储和管理\n * 4. 提示词记录的保存和查询\n */\n\nimport Dexie from 'dexie';\nimport type { User, Project, StyleConfig, PromptRecord } from './types';\n\n/**\n * 应用数据库类\n * 继承自 Dexie，用于管理应用程序的本地数据库\n */\nclass AppDatabase extends Dexie {\n  users: Dexie.Table<User, number>;         // 用户表\n  projects: Dexie.Table<Project, number>;   // 项目表\n  styleConfigs: Dexie.Table<StyleConfig, number>; // 风格配置表\n  promptRecords: Dexie.Table<PromptRecord, number>; // 提示词记录表\n\n  /**\n   * 数据库类构造函数\n   * 初始化数据库连接和表结构\n   */\n  constructor() {\n    super('SunoCoverArrangerDB');\n\n    // 定义数据库版本和表结构\n    this.version(1).stores({\n      users: '++id, name, email, createdAt',\n      projects: '++id, title, userId, createdAt, updatedAt',\n      styleConfigs: '++id, name, userId, isDefault, createdAt, updatedAt',\n      promptRecords: '++id, userId, createdAt'\n    });\n\n    // 初始化表\n    this.users = this.table('users');\n    this.projects = this.table('projects');\n    this.styleConfigs = this.table('styleConfigs');\n    this.promptRecords = this.table('promptRecords');\n  }\n\n  // 用户相关操作\n  /**\n   * 创建新用户\n   * @param user - 用户信息（不包含id和createdAt）\n   * @returns 包含id和createdAt的完整用户信息\n   */\n  async createUser(user: Omit<User, 'id' | 'createdAt'>): Promise<User> {\n    const newUser = {\n      ...user,\n      createdAt: new Date()\n    };\n    const id = await this.users.add(newUser);\n    return { ...newUser, id };\n  }\n\n  /**\n   * 根据ID获取用户信息\n   * @param id - 用户ID\n   * @returns 用户信息或undefined（如果用户不存在）\n   */\n  async getUser(id: number): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  /**\n   * 更新用户信息\n   * @param id - 用户ID\n   * @param updates - 要更新的用户信息部分\n   * @returns 更新的记录数\n   */\n  async updateUser(id: number, updates: Partial<User>): Promise<number> {\n    return this.users.update(id, updates);\n  }\n\n  /**\n   * 根据ID删除用户\n   * @param id - 用户ID\n   */\n  async deleteUser(id: number): Promise<void> {\n    await this.users.delete(id);\n  }\n\n  /**\n   * 获取所有用户信息\n   * @returns 用户信息数组\n   */\n  async getAllUsers(): Promise<User[]> {\n    return this.users.toArray();\n  }\n\n  // 项目相关操作\n  async createProject(project: Omit<Project, 'id' | 'createdAt' | 'updatedAt'>): Promise<Project> {\n    const now = new Date();\n    const newProject = {\n      ...project,\n      createdAt: now,\n      updatedAt: now\n    };\n    const id = await this.projects.add(newProject);\n    return { ...newProject, id };\n  }\n\n  async getProject(id: number): Promise<Project | undefined> {\n    return this.projects.get(id);\n  }\n\n  async updateProject(id: number, updates: Partial<Project>): Promise<number> {\n    return this.projects.update(id, { ...updates, updatedAt: new Date() });\n  }\n\n  async deleteProject(id: number): Promise<void> {\n    await this.projects.delete(id);\n  }\n\n  async getUserProjects(userId: number): Promise<Project[]> {\n    return this.projects.where('userId').equals(userId).toArray();\n  }\n\n  // 风格配置相关操作\n  async createStyleConfig(config: Omit<StyleConfig, 'id' | 'createdAt' | 'updatedAt'>): Promise<StyleConfig> {\n    const now = new Date();\n    const newConfig = {\n      ...config,\n      createdAt: now,\n      updatedAt: now\n    };\n    \n    // 如果设置为默认，取消其他默认配置\n    if (newConfig.isDefault) {\n      await this.styleConfigs\n        .where({ userId: newConfig.userId, isDefault: true })\n        .modify({ isDefault: false, updatedAt: now });\n    }\n    \n    const id = await this.styleConfigs.add(newConfig);\n    return { ...newConfig, id };\n  }\n\n  async getStyleConfig(id: number): Promise<StyleConfig | undefined> {\n    return this.styleConfigs.get(id);\n  }\n\n  async updateStyleConfig(id: number, updates: Partial<StyleConfig>): Promise<number> {\n    const now = new Date();\n    \n    // 如果设置为默认，取消其他默认配置\n    if (updates.isDefault) {\n      const config = await this.styleConfigs.get(id);\n      if (config) {\n        await this.styleConfigs\n          .where({ userId: config.userId, isDefault: true })\n          .modify({ isDefault: false, updatedAt: now });\n      }\n    }\n    \n    return this.styleConfigs.update(id, { ...updates, updatedAt: now });\n  }\n\n  async deleteStyleConfig(id: number): Promise<void> {\n    await this.styleConfigs.delete(id);\n  }\n\n  async getUserStyleConfigs(userId: number): Promise<StyleConfig[]> {\n    return this.styleConfigs.where('userId').equals(userId).toArray();\n  }\n\n  async getDefaultStyleConfig(userId: number): Promise<StyleConfig | undefined> {\n    return this.styleConfigs\n      .where({ userId, isDefault: true })\n      .first();\n  }\n\n  // 提示词生成记录相关操作\n  async createPromptRecord(record: Omit<PromptRecord, 'id' | 'createdAt'>): Promise<PromptRecord> {\n    const newRecord = {\n      ...record,\n      createdAt: new Date()\n    };\n    const id = await this.promptRecords.add(newRecord);\n    return { ...newRecord, id };\n  }\n\n  async getPromptRecord(id: number): Promise<PromptRecord | undefined> {\n    return this.promptRecords.get(id);\n  }\n\n  async updatePromptRecord(id: number, updates: Partial<PromptRecord>): Promise<number> {\n    return this.promptRecords.update(id, updates);\n  }\n\n  async deletePromptRecord(id: number): Promise<void> {\n    await this.promptRecords.delete(id);\n  }\n\n  async getUserPromptRecords(userId: number, limit?: number): Promise<PromptRecord[]> {\n    const query = this.promptRecords\n      .where('userId')\n      .equals(userId)\n      .sortBy('createdAt')\n      .then(records => records.reverse()); // 先排序，再反转，实现倒序\n\n    if (limit) {\n      return (await query).slice(0, limit);\n    }\n    return query;\n  }\n\n  async searchPromptRecords(userId: number, keyword: string, limit?: number): Promise<PromptRecord[]> {\n    const allRecords = await this.getUserPromptRecords(userId);\n    \n    const filteredRecords = allRecords.filter(record => {\n      const searchText = JSON.stringify(record).toLowerCase();\n      return searchText.includes(keyword.toLowerCase());\n    });\n\n    if (limit) {\n      return filteredRecords.slice(0, limit);\n    }\n    return filteredRecords;\n  }\n\n  async getRecentPromptRecords(userId: number, days: number = 7): Promise<PromptRecord[]> {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - days);\n\n    return this.promptRecords\n      .where('userId')\n      .equals(userId)\n      .and(record => record.createdAt >= cutoffDate)\n      .sortBy('createdAt')\n      .then(records => records.reverse());\n  }\n}\n\n// 导出单例实例\nexport const db = new AppDatabase();\n\n// 导出类型\nexport type { User, Project, StyleConfig, PromptRecord };\n"],"names":[],"mappings":"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"}