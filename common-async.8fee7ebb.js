(("undefined"!=typeof globalThis?globalThis:self)["makoChunk_suno-cover-arranger"]=("undefined"!=typeof globalThis?globalThis:self)["makoChunk_suno-cover-arranger"]||[]).push([["common"],{d5881563:function(e,t,s){"use strict";s.d(t,"__esModule",{value:!0}),s.d(t,"useApiKey",{enumerable:!0,get:function(){return i;}});var r=s("067db9e2"),a=s("e236400f");let i=()=>{let[e,t]=(0,r.useState)(""),[s,i]=(0,r.useState)("deepseek"),[o,d]=(0,r.useState)(!0),n=async e=>{try{console.log("Loading API Key for model:",e);let s=await a.db.getUserApiKeys(1);console.log("All user API Keys:",s);let r=s.find(t=>t.model===e);for(let o of(console.log("Found API Key for model",e,":",r),t((null==r?void 0:r.api_key)||""),i(e),console.log("Updating current API Key status for model",e),s))await a.db.updateApiKey(o.id,{is_current:o.model===e});}catch(s){console.error("Failed to load API Key for model:",e,s),t(""),i(e);}};(0,r.useEffect)(()=>{(async()=>{try{console.log("Loading initial API Key and Model...");let e=await a.db.getCurrentApiKey(1);e?(console.log("Found current API Key:",e),t(e.api_key),i(e.model)):(console.log("No current API Key found, using default model deepseek"),await n("deepseek"));}catch(e){console.error("Failed to load initial API Key and Model:",e);}finally{d(!1);}})();},[]);let l=async e=>{e!==s&&(d(!0),await n(e),d(!1));},u=async()=>{try{console.log("Deleting API Key for model:",s);let e=(await a.db.getUserApiKeys(1)).find(e=>e.model===s);return e&&(console.log("Deleting API Key with ID:",e.id),await a.db.deleteApiKey(e.id)),t(""),console.log("API Key deleted successfully"),!0;}catch(e){return console.error("Failed to delete API Key:",e),!1;}};return{apiKey:e,model:s,isLoading:o,saveApiKey:async(e,s="deepseek")=>{try{console.log("Saving API Key and Model:",{apiKey:e,model:s});let r=await a.db.createApiKey({user_id:1,api_key:e,model:s,is_current:!0});return console.log("Saved API Key and Model to DB:",r),t(e),i(s),!0;}catch(e){return console.error("Failed to save API Key and Model:",e),!1;}},deleteApiKey:u,validateApiKey:e=>{let t=e.trim();return/^sk-/.test(t)||/^AIza/.test(t)||/^sk-/.test(t);},switchModel:l};};},e236400f:function(e,t,s){s.d(t,"__esModule",{value:!0}),s.e(t,{db:function(){return n;}});var r=s("777fffbe"),a=s("fb57420d"),i=r._(a);let o=Symbol.for("Dexie"),d=globalThis[o]||(globalThis[o]=i.default);if(i.default.semVer!==d.semVer)throw Error(`Two different versions of Dexie loaded in the same app: ${i.default.semVer} and ${d.semVer}`);let n=new class extends d{users;projects;styleConfigs;promptRecords;apiKeys;constructor(){super("SunoCoverArrangerDB"),this.version(1).stores({users:"++id, name, email, created_at",projects:"++id, title, user_id, created_at, updated_at",styleConfigs:"++id, name, user_id, is_default, created_at, updated_at",promptRecords:"++id, user_id, created_at",apiKeys:"++id, user_id, api_key, model, is_current, created_at"}),this.version(2).stores({promptRecords:"++id, userId, createdAt"}),this.version(3).stores({users:"++id, name, email, created_at",projects:"++id, title, user_id, created_at, updated_at",styleConfigs:"++id, name, user_id, is_default, created_at, updated_at",promptRecords:"++id, user_id, created_at",apiKeys:"++id, user_id, api_key, model, is_current, created_at"}).upgrade(async e=>{console.log("\u6570\u636E\u5E93\u5347\u7EA7\u5230\u7248\u672C3\uFF0C\u91CD\u65B0\u521B\u5EFA\u8868\u7ED3\u6784");}),this.version(4).stores({users:"++id, name, email, created_at",projects:"++id, title, user_id, created_at, updated_at",styleConfigs:"++id, name, user_id, is_default, created_at, updated_at",promptRecords:"++id, user_id, created_at",apiKeys:"++id, user_id, api_key, model, is_current, created_at"}).upgrade(async e=>{console.log("\u6570\u636E\u5E93\u5347\u7EA7\u5230\u7248\u672C4\uFF0C\u7EDF\u4E00\u5B57\u6BB5\u547D\u540D\u89C4\u8303\u4E3Asnake_case");}),this.users=this.table("users"),this.projects=this.table("projects"),this.styleConfigs=this.table("styleConfigs"),this.promptRecords=this.table("promptRecords"),this.apiKeys=this.table("apiKeys");}async createUser(e){let t={...e,createdAt:new Date},s=await this.users.add(t);return{...t,id:s};}async getUser(e){return this.users.get(e);}async updateUser(e,t){return this.users.update(e,t);}async deleteUser(e){await this.users.delete(e);}async getAllUsers(){return this.users.toArray();}async createProject(e){let t=new Date,s={...e,createdAt:t,updatedAt:t},r=await this.projects.add(s);return{...s,id:r};}async getProject(e){return this.projects.get(e);}async updateProject(e,t){return this.projects.update(e,{...t,updatedAt:new Date});}async deleteProject(e){await this.projects.delete(e);}async getUserProjects(e){return this.projects.where("userId").equals(e).toArray();}async createStyleConfig(e){let t=new Date,s={...e,createdAt:t,updatedAt:t};s.isDefault&&await this.styleConfigs.where({userId:s.userId,isDefault:!0}).modify({isDefault:!1,updatedAt:t});let r=await this.styleConfigs.add(s);return{...s,id:r};}async getStyleConfig(e){return this.styleConfigs.get(e);}async updateStyleConfig(e,t){let s=new Date;if(t.isDefault){let t=await this.styleConfigs.get(e);t&&await this.styleConfigs.where({userId:t.userId,isDefault:!0}).modify({isDefault:!1,updatedAt:s});}return this.styleConfigs.update(e,{...t,updatedAt:s});}async deleteStyleConfig(e){await this.styleConfigs.delete(e);}async getUserStyleConfigs(e){return this.styleConfigs.where("userId").equals(e).toArray();}async getDefaultStyleConfig(e){return this.styleConfigs.where({userId:e,isDefault:!0}).first();}async createPromptRecord(e){let t={...e,created_at:new Date},s=await this.promptRecords.add(t);return{...t,id:s};}async getPromptRecord(e){return this.promptRecords.get(e);}async updatePromptRecord(e,t){return this.promptRecords.update(e,t);}async deletePromptRecord(e){await this.promptRecords.delete(e);}async getUserPromptRecords(e,t){let s=this.promptRecords.where("user_id").equals(e).sortBy("created_at").then(e=>e.reverse());return t?(await s).slice(0,t):s;}async searchPromptRecords(e,t,s){let r=(await this.getUserPromptRecords(e)).filter(e=>JSON.stringify(e).toLowerCase().includes(t.toLowerCase()));return s?r.slice(0,s):r;}async getRecentPromptRecords(e,t=7){let s=new Date;return s.setDate(s.getDate()-t),this.promptRecords.where("user_id").equals(e).and(e=>(e.created_at||new Date(0))>=s).sortBy("created_at").then(e=>e.reverse());}async createApiKey(e){console.log("Creating new API Key:",e);let t={...e,created_at:new Date};t.is_current&&(console.log("Setting new API Key as current, updating existing current keys..."),await this.apiKeys.where({user_id:t.user_id,is_current:!0}).modify({is_current:!1}));let s=await this.apiKeys.add(t),r={...t,id:s};return console.log("Created API Key:",r),r;}async getApiKey(e){return this.apiKeys.get(e);}async updateApiKey(e,t){if(t.is_current){let t=await this.apiKeys.get(e);t&&await this.apiKeys.where({user_id:t.user_id,is_current:!0}).modify({is_current:!1});}return this.apiKeys.update(e,t);}async deleteApiKey(e){await this.apiKeys.delete(e);}async getUserApiKeys(e){return this.apiKeys.where("user_id").equals(e).toArray();}async getCurrentApiKey(e){console.log("Getting current API Key for user:",e);let t=await this.apiKeys.where("user_id").equals(e).toArray();console.log("All user API Keys:",t);let s=t.find(e=>e.is_current);return console.log("Found current API Key:",s),s;}};}}]);
//# sourceMappingURL=common-async.8fee7ebb.js.map